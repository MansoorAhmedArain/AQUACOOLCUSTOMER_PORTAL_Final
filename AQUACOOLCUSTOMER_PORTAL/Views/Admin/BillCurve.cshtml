@model IEnumerable<AQUACOOLCUSTOMER_PORTAL.DTO.AxPayments>
@using AQUACOOLCUSTOMER_PORTAL.DTO
@{
}
<head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="images/fevicon.png" type="">

    <title>Bill Curve</title>


    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrapcss/bootstrap.min.css" />


    <!-- fonts style -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <!-- font awesome style -->
    <link href="css/font-awesome.min.css" rel="stylesheet" />

    <!-- Custom styles for this template -->
    <link href="/css/MoveinRequest/style.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="/css/MoveinRequest/responsive.css" rel="stylesheet" />

</head>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Optional styling -->
<style>
    .charts-wrapper {
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: wrap;
        margin-top: 50px;
    }
    .chart-container {
        width: 45%;
        text-align: center;
    }

    canvas {
        width: 100% !important;
        height: auto !important;
    }

    h4 {
        margin-bottom: 10px;
    }
    /* Responsive for mobile screens */
    @@media screen and (max-width: 980px) {
        .charts-wrapper{
        flex-direction: column;
        align-items: center; /* center charts */
        gap: 20px;
        }

        .chart-container {
            width: 100%;
            max-width: 100%;
        }

        .input-group {
            width: 95%;
            margin-left: auto;
            margin-right: auto;
        }
   
        h4, h6 {
            text-align: center; /* headings centered */
        }
        /* ↓↓↓ Add this block ↓↓↓ */
        select.form-control {
            font-size: 2vw !important; /* smaller font for mobile */
        }
        
    }
 
</style>
<h4 style="text-align:center; margin-top: 20px;"> Bill Curve</h4>
<div class="input-group mb-3" style="width: 30%; margin-left: auto; margin-right: auto;">
    <input type="hidden" name="selectedContract" id="selectedContractID" value="@ViewBag.SelectedContractEAG" />
    <select class="form-control rounded-pill" required placeholder="Select" name="EAG" style="border: 1px solid #8FD2F0;" id="EAGContractDropdown">
        <option value="">Select a contract</option>
        @{
            foreach (var item in (List<ContractIDs>)ViewBag.ContractsList)
            {
                <option value="@item.ID">@item.Name</option>
            }
        }
    </select>
</div>
<div class="charts-wrapper">
    <div class="chart-container">
        <h6>Energy Consumption</h6>
        <canvas id="energyChart"></canvas>
    </div>

    <div class="chart-container">
        <h6>Bill Consumption</h6>
        <canvas id="billChart"></canvas>
    </div>
</div>
<script>
    $(document).ready(function () {
         document.getElementById("EAGContractDropdown").addEventListener("change", function () {
        var selectedValue = this.value;
        if (selectedValue) {
            // Reload the page with the selected contractId as query parameter
            //window.location.href = "?contractId=" + encodeURIComponent(selectedValue);
             loadEnergyConsumption(selectedValue);
            loadBillConsumption(selectedValue);
        }
    });
         loadEnergyConsumption("");
            loadBillConsumption("");
    });

    let chart1;
    let chart2;

    function loadEnergyConsumption(contractId) {
        
        $.ajax({
            url: '/Admin/GetEnergyConsumption'+"?contractId=" + encodeURIComponent(contractId),
            method: 'GET',
            success: function (res) {
                let maxValue = Math.max(...res.data);
                let roundedMax;

                if (maxValue <= 1) {
                    roundedMax = 1;
                } else if (maxValue <= 10) {
                    roundedMax = Math.ceil(maxValue / 1) * 1;
                } else if (maxValue <= 100) {
                    roundedMax = Math.ceil(maxValue / 10) * 10;
                } else if (maxValue <= 1000) {
                    roundedMax = Math.ceil(maxValue / 100) * 100;
                } else {
                    roundedMax = Math.ceil(maxValue / 1000) * 1000;
                }



                const ctx = document.getElementById('energyChart').getContext('2d');

                if (chart1) chart1.destroy();

                chart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: res.labels,
                        datasets: [{
                            label: `AED`,
                            data: res.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: roundedMax,
                                ticks: {
                                    callback: function (value) {
                                        return `AED ${value.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    function loadBillConsumption(contractId) {
        $.ajax({
            url: '/Admin/GetBillConsumption'+"?contractId=" + encodeURIComponent(contractId),
            method: 'GET',
            success: function (res) {
                let maxValue = Math.max(...res.data);
                let roundedMax;

                if (maxValue <= 1) {
                    roundedMax = 1;
                } else if (maxValue <= 10) {
                    roundedMax = Math.ceil(maxValue / 1) * 1;
                } else if (maxValue <= 100) {
                    roundedMax = Math.ceil(maxValue / 10) * 10;
                } else if (maxValue <= 1000) {
                    roundedMax = Math.ceil(maxValue / 100) * 100;
                } else {
                    roundedMax = Math.ceil(maxValue / 1000) * 1000;
                }

                const ctx = document.getElementById('billChart').getContext('2d');

                if (chart2) chart2.destroy();

                chart2 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: res.labels,
                        datasets: [{
                            label: `AED`,
                            data: res.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: roundedMax,
                                ticks: {
                                    callback: function (value) {
                                        return `AED ${value.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    }
     
</script>
